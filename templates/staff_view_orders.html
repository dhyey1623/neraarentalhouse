{% extends 'base.html' %}

{% block title %}View Orders - NERAA Rental{% endblock %}

{% block extra_css %}
<style>
    .order-row {
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .order-row:hover {
        background-color: #f8fafc;
    }
    
    .product-item {
        background: #f8fafc;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 8px;
    }
    
    .product-image {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 6px;
        flex-shrink: 0;
    }
    
    .product-placeholder {
        width: 50px;
        height: 50px;
        background: #e2e8f0;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .detail-label {
        font-weight: 600;
        color: #64748b;
        font-size: 12px;
        text-transform: uppercase;
    }
    
    .accessory-badge {
        background: #e0f2fe;
        color: #0369a1;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        margin: 2px;
        display: inline-block;
    }
    
    .action-btns {
        white-space: nowrap;
    }
    
    /* Responsive Styles */
    @media (max-width: 768px) {
        .card-header h5 {
            font-size: 1rem;
        }
        
        .product-item {
            padding: 8px;
        }
        
        .product-image,
        .product-placeholder {
            width: 45px;
            height: 45px;
        }
        
        .detail-label {
            font-size: 11px;
        }
        
        .accessory-badge {
            font-size: 11px;
            padding: 3px 8px;
        }
        
        .table {
            font-size: 13px;
        }
        
        .table th,
        .table td {
            padding: 10px 8px;
        }
        
        .badge {
            font-size: 10px;
            padding: 4px 8px;
        }
        
        .action-btns .btn {
            padding: 6px 10px;
        }
        
        .modal-body .card {
            margin-bottom: 12px;
        }
        
        .modal-body .card-body {
            padding: 12px;
        }
    }
    
    @media (max-width: 576px) {
        h4 {
            font-size: 1.1rem;
        }
        
        .card-header h5 {
            font-size: 0.95rem;
        }
        
        .form-label {
            font-size: 13px;
            margin-bottom: 5px;
        }
        
        .form-control {
            font-size: 14px;
            padding: 10px 12px;
        }
        
        .btn {
            font-size: 13px;
            padding: 10px 12px;
        }
        
        .btn-sm {
            font-size: 12px;
            padding: 6px 10px;
        }
        
        .product-item {
            padding: 8px;
            margin-bottom: 6px;
        }
        
        .product-image,
        .product-placeholder {
            width: 40px;
            height: 40px;
        }
        
        .product-item .badge {
            font-size: 10px;
        }
        
        .product-item div {
            font-size: 13px;
        }
        
        .accessory-badge {
            font-size: 10px;
            padding: 3px 7px;
        }
        
        .table {
            font-size: 12px;
        }
        
        .table th,
        .table td {
            padding: 8px 6px;
        }
        
        .badge {
            font-size: 10px;
            padding: 3px 7px;
        }
        
        .action-btns .btn {
            padding: 5px 8px;
        }
        
        .action-btns .btn i {
            font-size: 13px;
        }
        
        /* Modal adjustments */
        .modal-dialog {
            margin: 8px;
        }
        
        .modal-header {
            padding: 12px 15px;
        }
        
        .modal-title {
            font-size: 1rem;
        }
        
        .modal-body {
            padding: 12px;
        }
        
        .modal-body .card {
            margin-bottom: 10px;
        }
        
        .modal-body .card-body {
            padding: 10px;
            font-size: 13px;
        }
        
        .modal-body .card-body p {
            font-size: 13px;
            margin-bottom: 6px;
        }
        
        .modal-body .detail-label {
            font-size: 10px;
            margin-bottom: 8px;
        }
        
        .modal-body .h5 {
            font-size: 1rem;
        }
        
        .modal-body .h4 {
            font-size: 1.2rem;
        }
        
        .modal-body .table {
            font-size: 11px;
        }
        
        .modal-body .table th,
        .modal-body .table td {
            padding: 6px 4px;
        }
        
        .modal-footer {
            padding: 10px 12px;
        }
        
        .modal-footer .btn {
            font-size: 13px;
            padding: 8px 12px;
        }
        
        /* Search form adjustments */
        .row.g-3 {
            gap: 0.75rem !important;
        }
        
        .col-md-4,
        .col-md-3,
        .col-md-2 {
            margin-bottom: 8px;
        }
    }
    
    @media (max-width: 400px) {
        h4 {
            font-size: 1rem;
        }
        
        .card-header h5 {
            font-size: 0.9rem;
        }
        
        .btn {
            font-size: 12px;
            padding: 8px 10px;
        }
        
        .product-item {
            padding: 6px;
        }
        
        .product-image,
        .product-placeholder {
            width: 35px;
            height: 35px;
        }
        
        .table {
            font-size: 11px;
        }
        
        .table th,
        .table td {
            padding: 6px 4px;
        }
        
        .modal-body .card-body {
            padding: 8px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h4 class="mb-0"><i class="bi bi-list-task me-2"></i>All Orders</h4>
        <a href="{{ url_for('create_order') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle me-1"></i>New Order
        </a>
    </div>
    
    <!-- Search Section -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Search by Product Code</label>
                    <input type="text" name="search" class="form-control" 
                           value="{{ request.args.get('search', '') }}" 
                           placeholder="Enter product code">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Search by Customer</label>
                    <input type="text" name="customer" class="form-control" 
                           value="{{ request.args.get('customer', '') }}" 
                           placeholder="Customer name or phone">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Filter by Date</label>
                    <input type="date" name="date" class="form-control" 
                           value="{{ request.args.get('date', '') }}">
                </div>
                <div class="col-md-2 d-flex align-items-end gap-2">
                    <button type="submit" class="btn btn-primary flex-grow-1">
                        <i class="bi bi-search"></i>
                    </button>
                    <a href="{{ url_for('staff_view_orders') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-x-lg"></i>
                    </a>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Product Availability Check -->
    <div class="card mb-4">
        <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-calendar-check me-2"></i>Check Product Booking Status</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-8">
                    <input type="text" id="productCodeCheck" class="form-control" 
                           placeholder="Enter Product Code to check if booked">
                </div>
                <div class="col-md-4">
                    <button type="button" class="btn btn-outline-primary w-100" onclick="checkProductStatus()">
                        <i class="bi bi-search me-1"></i>Check Status
                    </button>
                </div>
            </div>
            <div id="productStatusResult" class="mt-3" style="display: none;"></div>
        </div>
    </div>
    
    <!-- Orders List -->
    <div class="card">
        <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-cart me-2"></i>Orders ({{ orders|length }})</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Customer</th>
                            <th class="d-none d-md-table-cell">Products</th>
                            <th>Delivery</th>
                            <th class="d-none d-md-table-cell">Return</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr class="order-row" onclick="showOrderDetails({{ order.id }})">
                            <td>#{{ order.id }}</td>
                            <td>
                                {{ order.customer.name }}
                                <br><small class="text-muted">{{ order.customer.phone }}</small>
                            </td>
                            <td class="d-none d-md-table-cell">
                                {% for item in order.items[:2] %}
                                <span class="badge bg-secondary me-1">{{ item.product.product_code }}</span>
                                {% endfor %}
                                {% if order.items|length > 2 %}
                                <span class="badge bg-light text-dark">+{{ order.items|length - 2 }} more</span>
                                {% endif %}
                            </td>
                            <td>{{ order.delivery_date.strftime('%d-%m-%Y') }}</td>
                            <td class="d-none d-md-table-cell">{{ order.return_date.strftime('%d-%m-%Y') }}</td>
                            <td>₹{{ "%.0f"|format(order.total_amount) }}</td>
                            <td>
                                {% if order.status == 'pending' %}
                                <span class="badge bg-warning">Pending</span>
                                {% elif order.status == 'approved' %}
                                <span class="badge bg-success">Approved</span>
                                {% elif order.status == 'completed' %}
                                <span class="badge bg-info">Completed</span>
                                {% elif order.status == 'cancelled' %}
                                <span class="badge bg-danger">Cancelled</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ order.status }}</span>
                                {% endif %}
                            </td>
                            <td class="action-btns" onclick="event.stopPropagation();">
                                <a href="{{ url_for('view_invoice', order_id=order.id) }}" class="btn btn-sm btn-outline-primary" title="View Invoice">
                                    <i class="bi bi-receipt"></i>
                                </a>
                                {% if order.status == 'pending' %}
                                <a href="{{ url_for('add_products_to_order', order_id=order.id) }}" class="btn btn-sm btn-outline-success" title="Add Products">
                                    <i class="bi bi-plus"></i>
                                </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="8" class="text-center py-4 text-muted">No orders found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-cart me-2"></i>Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="orderDetailsContent">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" id="viewInvoiceBtn" class="btn btn-primary">
                    <i class="bi bi-receipt me-1"></i>View Invoice
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Hidden div to store orders data -->
{% for order in orders %}
<div class="order-data d-none" 
     data-order-id="{{ order.id }}"
     data-transaction-id="{{ order.transaction_id }}"
     data-customer-name="{{ order.customer.name }}"
     data-customer-phone="{{ order.customer.phone }}"
     data-customer-secondary="{{ order.customer.secondary_phone or '' }}"
     data-customer-email="{{ order.customer.email or '' }}"
     data-customer-address="{{ order.customer.address or '' }}"
     data-staff-name="{{ order.staff.name }}"
     data-delivery-date="{{ order.delivery_date.strftime('%d-%m-%Y') }}"
     data-return-date="{{ order.return_date.strftime('%d-%m-%Y') }}"
     data-status="{{ order.status }}"
     data-total="{{ order.total_amount }}"
     data-notes="{{ order.notes or '' }}">
    
    <!-- Products -->
    {% for item in order.items %}
    <div class="product-data"
         data-code="{{ item.product.product_code }}"
         data-name="{{ item.product.name }}"
         data-price="{{ item.price }}"
         data-image="{{ item.product.image_path or '' }}"></div>
    {% endfor %}
    
    <!-- Accessories -->
    {% for acc in order.accessories %}
    <div class="accessory-data"
         data-name="{{ acc.accessory_name }}"
         data-remarks="{{ acc.remarks or '' }}"></div>
    {% endfor %}
    
    <!-- Extra Charges -->
    {% for extra in order.extra_charges %}
    <div class="extra-data"
         data-description="{{ extra.description }}"
         data-amount="{{ extra.amount }}"
         data-remarks="{{ extra.remarks or '' }}"></div>
    {% endfor %}
</div>
{% endfor %}
{% endblock %}

{% block extra_js %}
<script>
function getOrderData(orderId) {
    const orderDiv = document.querySelector(`.order-data[data-order-id="${orderId}"]`);
    if (!orderDiv) return null;
    
    const products = [];
    orderDiv.querySelectorAll('.product-data').forEach(p => {
        products.push({
            code: p.dataset.code,
            name: p.dataset.name,
            price: parseFloat(p.dataset.price),
            image: p.dataset.image
        });
    });
    
    const accessories = [];
    orderDiv.querySelectorAll('.accessory-data').forEach(a => {
        accessories.push({
            name: a.dataset.name,
            remarks: a.dataset.remarks
        });
    });
    
    const extraCharges = [];
    orderDiv.querySelectorAll('.extra-data').forEach(e => {
        extraCharges.push({
            description: e.dataset.description,
            amount: parseFloat(e.dataset.amount),
            remarks: e.dataset.remarks
        });
    });
    
    return {
        id: orderId,
        transactionId: orderDiv.dataset.transactionId,
        customer: {
            name: orderDiv.dataset.customerName,
            phone: orderDiv.dataset.customerPhone,
            secondary: orderDiv.dataset.customerSecondary,
            email: orderDiv.dataset.customerEmail,
            address: orderDiv.dataset.customerAddress
        },
        staff: orderDiv.dataset.staffName,
        deliveryDate: orderDiv.dataset.deliveryDate,
        returnDate: orderDiv.dataset.returnDate,
        status: orderDiv.dataset.status,
        total: parseFloat(orderDiv.dataset.total),
        notes: orderDiv.dataset.notes,
        products: products,
        accessories: accessories,
        extraCharges: extraCharges
    };
}

function showOrderDetails(orderId) {
    const order = getOrderData(orderId);
    if (!order) return;
    
    const statusBadge = {
        'pending': '<span class="badge bg-warning">Pending</span>',
        'approved': '<span class="badge bg-success">Approved</span>',
        'completed': '<span class="badge bg-info">Completed</span>',
        'cancelled': '<span class="badge bg-danger">Cancelled</span>'
    };
    
    let productsHtml = order.products.map(item => `
        <div class="product-item d-flex align-items-center gap-3">
            ${item.image ? 
                `<img src="/static/${item.image}" class="product-image" alt="${item.name}">` : 
                `<div class="product-placeholder"><i class="bi bi-image text-muted"></i></div>`
            }
            <div class="flex-grow-1">
                <span class="badge bg-secondary">${item.code}</span>
                <div>${item.name}</div>
            </div>
            <div class="text-primary fw-bold">₹${item.price.toLocaleString('en-IN')}</div>
        </div>
    `).join('');
    
    let accessoriesHtml = '';
    if (order.accessories.length > 0) {
        accessoriesHtml = `
            <div class="mt-4">
                <p class="detail-label mb-2">Accessories</p>
                <div>
                    ${order.accessories.map(acc => `
                        <span class="accessory-badge">
                            <i class="bi bi-check-circle me-1"></i>${acc.name}
                            ${acc.remarks ? `<small>(${acc.remarks})</small>` : ''}
                        </span>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    let extraChargesHtml = '';
    if (order.extraCharges.length > 0) {
        extraChargesHtml = `
            <div class="mt-4">
                <p class="detail-label mb-2">Extra Charges</p>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Description</th>
                                <th>Remarks</th>
                                <th class="text-end">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${order.extraCharges.map(extra => `
                                <tr>
                                    <td>${extra.description}</td>
                                    <td>${extra.remarks || '-'}</td>
                                    <td class="text-end">₹${extra.amount.toLocaleString('en-IN')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }
    
    const content = `
        <div class="row g-4">
            <!-- Order Info -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body">
                        <p class="detail-label mb-2">Order Information</p>
                        <p class="mb-1"><strong>Order ID:</strong> #${order.id}</p>
                        <p class="mb-1"><strong>Transaction:</strong> ${order.transactionId}</p>
                        <p class="mb-1"><strong>Created By:</strong> ${order.staff}</p>
                        <p class="mb-1"><strong>Status:</strong> ${statusBadge[order.status] || order.status}</p>
                        <hr>
                        <p class="mb-1"><strong>Delivery:</strong> ${order.deliveryDate}</p>
                        <p class="mb-0"><strong>Return:</strong> ${order.returnDate}</p>
                    </div>
                </div>
            </div>
            
            <!-- Customer Info -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body">
                        <p class="detail-label mb-2">Customer Details</p>
                        <p class="mb-1"><strong><i class="bi bi-person me-2"></i>${order.customer.name}</strong></p>
                        <p class="mb-1"><i class="bi bi-telephone me-2"></i>${order.customer.phone}</p>
                        ${order.customer.secondary ? `<p class="mb-1"><i class="bi bi-telephone me-2"></i>${order.customer.secondary} (Alt)</p>` : ''}
                        ${order.customer.email ? `<p class="mb-1"><i class="bi bi-envelope me-2"></i>${order.customer.email}</p>` : ''}
                        ${order.customer.address ? `<p class="mb-0"><i class="bi bi-geo-alt me-2"></i>${order.customer.address}</p>` : ''}
                    </div>
                </div>
            </div>
            
            <!-- Products -->
            <div class="col-12">
                <p class="detail-label mb-2">Products (${order.products.length})</p>
                ${productsHtml}
            </div>
            
            ${accessoriesHtml}
            ${extraChargesHtml}
            
            <!-- Notes -->
            ${order.notes ? `
            <div class="col-12">
                <p class="detail-label mb-2">Notes</p>
                <div class="alert alert-light mb-0">${order.notes}</div>
            </div>
            ` : ''}
            
            <!-- Total -->
            <div class="col-12">
                <div class="card bg-primary text-white">
                    <div class="card-body d-flex justify-content-between align-items-center py-3">
                        <span class="h5 mb-0">Total Amount</span>
                        <span class="h4 mb-0">₹${order.total.toLocaleString('en-IN')}</span>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('orderDetailsContent').innerHTML = content;
    document.getElementById('viewInvoiceBtn').href = '/order/' + order.id + '/invoice';
    
    new bootstrap.Modal(document.getElementById('orderDetailsModal')).show();
}

function checkProductStatus() {
    const productCode = document.getElementById('productCodeCheck').value.trim();
    if (!productCode) {
        alert('Please enter a product code');
        return;
    }
    
    fetch('/api/check-availability', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ product_code: productCode })
    })
    .then(response => response.json())
    .then(data => {
        const resultDiv = document.getElementById('productStatusResult');
        resultDiv.style.display = 'block';
        
        if (!data.found) {
            resultDiv.innerHTML = `
                <div class="alert alert-danger mb-0">
                    <i class="bi bi-x-circle me-2"></i>Product not found!
                </div>
            `;
            return;
        }
        
        let html = `
            <div class="card">
                <div class="card-header bg-light">
                    <strong>${data.product.code}</strong> - ${data.product.name}
                    <span class="float-end text-primary">₹${data.product.price}/product</span>
                </div>
                <div class="card-body">
        `;
        
        if (data.is_available) {
            html += `
                <div class="alert alert-success mb-0">
                    <i class="bi bi-check-circle me-2"></i>
                    <strong>Available!</strong> This product is not currently booked.
                </div>
            `;
        } else {
            html += `
                <div class="alert alert-warning mb-3">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Booked!</strong> This product has the following bookings:
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Delivery Date</th>
                                <th>Return Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.bookings.forEach(booking => {
                html += `
                    <tr>
                        <td>#${booking.order_id}</td>
                        <td>${booking.customer}</td>
                        <td>${booking.delivery_date}</td>
                        <td>${booking.return_date}</td>
                        <td>
                            <span class="badge bg-${booking.status === 'pending' ? 'warning' : 'success'}">
                                ${booking.status}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        html += '</div></div>';
        resultDiv.innerHTML = html;
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error checking product status');
    });
}

// Enter key support for product check
document.getElementById('productCodeCheck').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        checkProductStatus();
    }
});
</script>
{% endblock %}
