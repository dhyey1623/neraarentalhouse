{% extends 'base.html' %}

{% block title %}Add Products to Order #{{ order.id }} - NERAA Rental{% endblock %}

{% block extra_css %}
<style>
    .product-card { background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 10px; padding: 12px; margin-bottom: 8px; }
    .product-card.selected { border-color: #6366f1; background: #f0f0ff; }
    .product-card.existing { border-color: #10b981; background: #ecfdf5; }
    .product-img { width: 45px; height: 45px; object-fit: cover; border-radius: 6px; }
    .product-placeholder { width: 45px; height: 45px; background: #e2e8f0; border-radius: 6px; display: flex; align-items: center; justify-content: center; }
    .search-results { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-height: 200px; overflow-y: auto; z-index: 1000; display: none; }
    .search-results.show { display: block; }
    .search-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 10px; }
    .search-item:hover { background: #f8fafc; }
    .search-item img { width: 35px; height: 35px; object-fit: cover; border-radius: 6px; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h4 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Add Products</h4>
            <small class="text-muted">Order #{{ order.id }} - {{ order.customer.name }}</small>
        </div>
        <a href="{% if current_user.role == 'admin' %}{{ url_for('manage_orders') }}{% else %}{{ url_for('staff_view_orders') }}{% endif %}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left me-1"></i>Back
        </a>
    </div>
    
    <!-- Order Info -->
    <div class="card mb-3">
        <div class="card-body py-2">
            <div class="row align-items-center">
                <div class="col-6 col-md-3">
                    <small class="text-muted d-block">Customer</small>
                    <strong>{{ order.customer.name }}</strong>
                </div>
                <div class="col-6 col-md-3">
                    <small class="text-muted d-block">Phone</small>
                    <span>{{ order.customer.phone }}</span>
                </div>
                <div class="col-6 col-md-3">
                    <small class="text-muted d-block">Dates</small>
                    <span>{{ order.delivery_date.strftime('%d-%m') }} â†’ {{ order.return_date.strftime('%d-%m') }}</span>
                </div>
                <div class="col-6 col-md-3 text-md-end">
                    <small class="text-muted d-block">Current Total</small>
                    <strong class="text-primary h5 mb-0">â‚¹{{ "%.0f"|format(order.total_amount) }}</strong>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Current Products -->
    <div class="card mb-3">
        <div class="card-header py-2 bg-success text-white">
            <h6 class="mb-0"><i class="bi bi-check-circle me-2"></i>Current Products ({{ order.items|length }})</h6>
        </div>
        <div class="card-body py-2">
            {% for item in order.items %}
            <div class="product-card existing">
                <div class="d-flex align-items-center gap-2">
                    {% if item.product.image_path %}
                    <img src="{{ url_for('static', filename=item.product.image_path) }}" class="product-img">
                    {% else %}
                    <div class="product-placeholder"><i class="bi bi-image"></i></div>
                    {% endif %}
                    <div class="flex-grow-1">
                        <span class="badge bg-secondary">{{ item.product.product_code }}</span>
                        <span class="small">{{ item.product.name }}</span>
                    </div>
                    <span class="text-success fw-bold">â‚¹{{ "%.0f"|format(item.price) }}</span>
                    <span class="badge bg-success"><i class="bi bi-check"></i></span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Add New Products -->
    <form method="POST">
        <div class="card mb-3">
            <div class="card-header py-2">
                <h6 class="mb-0"><i class="bi bi-plus-square me-2"></i>Add New Products</h6>
            </div>
            <div class="card-body py-3">
                <div class="position-relative mb-3">
                    <input type="text" id="productSearch" class="form-control" placeholder="ðŸ” Search product code or name...">
                    <div id="searchResults" class="search-results"></div>
                </div>
                <div id="selectedProducts">
                    <p class="text-muted small mb-0">Search and select products to add</p>
                </div>
            </div>
        </div>
        
        <div class="d-flex gap-2 mb-4 flex-wrap">
            <button type="submit" class="btn btn-primary" id="submitBtn">
                <i class="bi bi-plus-circle me-1"></i>Add Products to Order
            </button>
            <a href="{% if current_user.role == 'admin' %}{{ url_for('manage_orders') }}{% else %}{{ url_for('staff_view_orders') }}{% endif %}" class="btn btn-outline-secondary">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
const productsData = JSON.parse('{{ products|tojson|safe }}');
const existingIds = [{% for item in order.items %}{{ item.product_id }}{% if not loop.last %},{% endif %}{% endfor %}];
let selectedProducts = [];

const searchInput = document.getElementById('productSearch');
const searchResults = document.getElementById('searchResults');

searchInput.addEventListener('input', function() {
    const q = this.value.toLowerCase().trim();
    if (q.length < 1) { searchResults.classList.remove('show'); return; }
    
    const matches = productsData.filter(p => 
        (p.product_code.toLowerCase().includes(q) || p.name.toLowerCase().includes(q)) &&
        !existingIds.includes(p.id) && 
        !selectedProducts.find(s => s.id === p.id)
    );
    
    if (matches.length === 0) {
        searchResults.innerHTML = '<div class="p-3 text-muted">No available products found</div>';
    } else {
        searchResults.innerHTML = matches.map(p => `
            <div class="search-item" onclick="selectProduct(${p.id})">
                ${p.image_path ? `<img src="/static/${p.image_path}" alt="">` : `<div class="product-placeholder" style="width:35px;height:35px;"><i class="bi bi-image"></i></div>`}
                <div class="flex-grow-1">
                    <strong>${p.product_code}</strong> - ${p.name}
                    <div class="text-primary small">â‚¹${p.rental_price}</div>
                </div>
            </div>
        `).join('');
    }
    searchResults.classList.add('show');
});

searchInput.addEventListener('blur', () => setTimeout(() => searchResults.classList.remove('show'), 200));

function selectProduct(id) {
    const p = productsData.find(x => x.id === id);
    if (!p || selectedProducts.find(x => x.id === id)) return;
    selectedProducts.push(p);
    searchInput.value = '';
    searchResults.classList.remove('show');
    render();
}

function removeProduct(id) {
    selectedProducts = selectedProducts.filter(p => p.id !== id);
    render();
}

function render() {
    const container = document.getElementById('selectedProducts');
    if (selectedProducts.length === 0) {
        container.innerHTML = '<p class="text-muted small mb-0">Search and select products to add</p>';
        document.getElementById('submitBtn').disabled = true;
        return;
    }
    
    document.getElementById('submitBtn').disabled = false;
    container.innerHTML = selectedProducts.map(p => `
        <div class="product-card selected">
            <div class="d-flex align-items-center gap-2">
                ${p.image_path ? `<img src="/static/${p.image_path}" class="product-img">` : `<div class="product-placeholder"><i class="bi bi-image"></i></div>`}
                <div class="flex-grow-1">
                    <span class="badge bg-primary">NEW</span>
                    <span class="badge bg-secondary">${p.product_code}</span>
                    <span class="small">${p.name}</span>
                </div>
                <span class="text-primary fw-bold">â‚¹${p.rental_price}</span>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeProduct(${p.id})"><i class="bi bi-x"></i></button>
            </div>
            <input type="hidden" name="product_id[]" value="${p.id}">
        </div>
    `).join('');
}

// Initial state
document.getElementById('submitBtn').disabled = true;
</script>
{% endblock %}
